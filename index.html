<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Playlist</title>
  <style>
    :root{
      --bg:#1b1a37;
      --card:#151621;
      --txt:#f6f7fb;
      --muted:#a9afc3;
      --play:#aa00ff;
    }

    html,body{
      margin:0;height:100%;
      background:var(--bg);
      color:var(--txt);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Helvetica,Arial,sans-serif;
    }

    .grid{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
      gap:12px;
      padding:16px;
    }

    .card{
      background:var(--card);
      border:1px solid #24263a;
      border-radius:16px;
      padding:14px;
      display:flex;
      flex-direction:column;
      justify-content:space-between;
      gap:10px;
      min-height:110px;
    }

    .title{font-weight:700;font-size:15px;line-height:1.3;}
    .muted{color:var(--muted);font-size:12px;}
    .controls{display:flex;gap:8px;align-items:center;flex-wrap:wrap;}

    .btn{
      appearance:none;
      border:0;
      border-radius:14px;
      padding:10px 14px;
      background:var(--play);
      color:#fff;
      font-weight:600;
      cursor:pointer;
      transition:transform .05s ease, box-shadow .2s ease;
    }
    .btn:active{transform:translateY(1px);box-shadow:0 0 0 6px rgba(170,0,255,.15);}
  </style>
</head>
<body>
  <main class="grid" id="grid"></main>

  <template id="cardTpl">
    <div class="card">
      <div class="title"></div>
      <div class="muted time"></div>
      <div class="controls">
        <button class="btn play">▶️ Lire</button>
      </div>
    </div>
  </template>

  <script>
    const grid=document.getElementById('grid');
    let audios=[];

    function fmt(t){
      if(!isFinite(t)||t<0)t=0;
      const m=Math.floor(t/60).toString().padStart(2,'0');
      const s=Math.floor(t%60).toString().padStart(2,'0');
      return `${m}:${s}`;
    }

    function parseStart(v){
      if(typeof v==='number')return Math.max(0,v);
      if(typeof v==='string'){
        const m=v.trim().match(/^(\d{1,2}):(\d{2})(?::(\d{2}))?$/);
        if(m){
          const h=m[3]?parseInt(m[1]):0;
          const mm=m[3]?parseInt(m[2]):parseInt(m[1]);
          const ss=m[3]?parseInt(m[3]):parseInt(m[2]);
          return (h*3600+mm*60+ss)|0;
        }
        const secs=Number(v);
        if(!isNaN(secs))return Math.max(0,secs);
      }
      return 0;
    }

    function makeCard(track,index){
      const tpl=document.getElementById('cardTpl');
      const node=tpl.content.firstElementChild.cloneNode(true);
      const title=node.querySelector('.title');
      const time=node.querySelector('.time');
      const play=node.querySelector('.play');

      const start=parseStart(track.start||0);
      title.textContent=track.title||(track.src||'').split('/').pop().replace(/\.[^.]+$/,'');

      const audio=new Audio(track.src);
      audio.preload='auto';
      audio.volume=parseFloat(localStorage.getItem('sb_volume')||'1');
      let primed=false;

      audio.addEventListener('timeupdate',()=>{
        time.textContent=`${fmt(audio.currentTime)} / ${fmt(audio.duration||0)}`;
      });
      audio.addEventListener('ended',()=>{
        play.textContent='▶️ Lire';
      });

      play.addEventListener('click',()=>{
        audios.forEach(o=>{
          if(o.audio!==audio){
            o.audio.pause();
            o.audio.currentTime=0;
            if(o.btn)o.btn.textContent='▶️ Lire';
          }
        });
        if(audio.paused){
          if(!primed){audio.currentTime=start;primed=true;}
          audio.play();play.textContent='⏸️ Pause';
        }else{
          audio.pause();play.textContent='▶️ Lire';
        }
      });

      audios[index]={audio,start,btn:play};
      grid.appendChild(node);
    }

    async function loadTracks(){
      try{
        const res=await fetch('tracks.json',{cache:'no-store'});
        if(!res.ok)throw new Error('HTTP '+res.status);
        const list=await res.json();
        if(!Array.isArray(list)||!list.length)return;
        list.forEach((t,i)=>makeCard(t,i));
      }catch(e){console.error('Erreur chargement tracks.json',e);}
    }

    loadTracks();
  </script>
</body>
</html>
